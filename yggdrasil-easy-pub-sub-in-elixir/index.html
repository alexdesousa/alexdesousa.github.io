<!DOCTYPE html>
<html lang="en">
  <head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="An overview of Yggdrasil's capabilities." />
<meta name="robots" content="index, follow">
<meta name="author" content="alex" />
<title>Yggdrasil: Easy Pub-Sub in Elixir | The Broken Link</title>
<link rel="canonical" href="https://thebroken.link/yggdrasil-easy-pub-sub-in-elixir/"/>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
<link rel="manifest" href="/assets/favicon/site.webmanifest">
<link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#FFFFFF">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="theme-color" content="#FFFFFF">
<meta itemprop="description" content="An overview of Yggdrasil's capabilities." />
<meta itemprop="image" content="/yggdrasil-easy-pub-sub-in-elixir/tree.jpg" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="The Broken Link" />
<meta property="og:title" content="Yggdrasil: Easy Pub-Sub in Elixir" />
<meta property="og:image" content="https://thebroken.link/yggdrasil-easy-pub-sub-in-elixir/tree.jpg" />
<meta property="og:url" content="https://thebroken.link/yggdrasil-easy-pub-sub-in-elixir/" />
<meta property="og:description" content="An overview of Yggdrasil's capabilities." />
<meta name="twitter:title" content="Yggdrasil: Easy Pub-Sub in Elixir"/>
<meta name="twitter:description" content="An overview of Yggdrasil's capabilities." />
<meta name="twitter:image" content="https://thebroken.link/yggdrasil-easy-pub-sub-in-elixir/tree.jpg" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image:alt" content="An overview of Yggdrasil's capabilities."/>
<meta name="twitter:site" content="@thebroken_link">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://thebroken.link/yggdrasil-easy-pub-sub-in-elixir/"
  },
  "headline": "Yggdrasil: Easy Pub-Sub in Elixir",
  "image": ["https://thebroken.link/assets/images/logo.png"],
  "datePublished": "2019-07-06T00:00:00+00:00",
  "dateModified": "2019-07-06T00:00:00+00:00",
  "author": {
    "@type": "Person",
    "name": "alex"
  },
  "publisher": {
    "@type": "Organization",
    "name": "The Broken Link",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thebroken.link/assets/images/logo.png"
    }
  },
  "description": "An overview of Yggdrasil's capabilities."
}
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-85600451-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-85600451-1', {'anonymize_ip':true});
</script><link rel="stylesheet" href="/assets/css/tailwind.css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css"
      rel="stylesheet"
      integrity="sha384-xyZLiqnBEFn1hDkS8VeG/YHoqOjS/ucimT8TI6GDr9+ZP1UNbZr6d/q0ldMi/xvL"
      crossorigin="anonymous"/>
<script type="text/javascript" src="/assets/js/app.js"></script>

    <link rel="stylesheet" href="/assets/css/pygments/monokai.css" />
    <style>
      #progress-bar {
        --scroll: 0%;
        background: linear-gradient(to right, #9E7BEA var(--scroll), transparent 0);
        height: 0.25rem;
        width: 100%;
      }
    </style>
  </head>
  <body class="font-sans leading-normal tracking-normal bg-gray-100"><nav class="sticky top-0 z-50 flex flex-col w-full mt-0">
  <div class="flex justify-center w-full bg-elixir-900">
    <div class="container flex py-2 px-4 bg-elixir-900">
      <div class="container flex items-center mx-auto">
        <div class="flex font-extrabold">
          <a class="hover:no-underline" href="https://thebroken.link/en/">
            <span class="text-base font-bold md:tracking-wider text-elixir-100 hover:text-white"><svg
  class="inline stroke-current text-elixir-100 w-6 h-6"
   viewBox="0 0 69.572713 69.572715">
  <g>
    <path
       style="fill:none;stroke-width:2.91042;stroke-linecap:butt;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 23.864295,1.579337 14.99178,24.721084 -12.37421,0.60924 15.62853,23.161723 L 2.4193453,17.515564 18.357715,17.818914 5.3962653,1.455208 Z"/>
    <path
       style="fill:none;stroke-width:4.7625;stroke-linecap:square;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 41.021355,10.837556 c 0,0 17.70631,-8.639798 23.91889,7.395197 6.504443,16.788311 -13.56254,23.213201 -13.56254,23.213201"/>
    <path
       style="fill:none;stroke-width:4.7625;stroke-linecap:square;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 36.521655,54.560714 c 0,0 -8.42371,19.61708 -23.89037,9.96633 -15.4666597,-9.65075 -3.0563697,-26.62966 -3.0563697,-26.62966"/>
  </g>
</svg>
The Broken Link</span>
          </a>
        </div>
        <div class="flex pl-2 text-sm md:pl-4">
          <ul class="flex items-center justify-between flex-1 list-reset md:flex-none"></ul>
        </div>
      </div>
      <div class="flex items-center justify-end w-1/2 align-baseline">
        <p class="hidden py-4 mr-3 text-sm font-bold text-center text-elixir-100 md:block">
          <span class="pr-1">Share this</span> ðŸ‘‰
        </p>
        <a class="inline-block w-8 h-8 text-center no-underline text-elixir-100 hover:text-white hover:text-underline md:h-auto md:w-16 md:p-4"
           href="https://twitter.com/intent/tweet?text=An+overview+of+Yggdrasil%27s+capabilities.&url=https%3A%2F%2Fthebroken.link%2Fyggdrasil-easy-pub-sub-in-elixir&via=thebroken_link">
          <svg class="h-8 fill-current" viewBox="0 0 32 32">
            <path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z">
            </path>
          </svg>
        </a>
      </div>
    </div>
  </div>

  <div id="progress-bar"></div>
</nav>
<div class="container w-full mx-auto pt-8 text-center md:pt-16">
  <p class="text-sm font-bold text-elixir-600 md:text-base">Written by Alex de Sousa</p>
  <h1 class="text-3xl font-bold break-normal md:text-5xl text-elixir-900">Yggdrasil: Easy Pub-Sub in Elixir</h1>
</div>

<div class="container text-sm text-right w-full max-w-6xl mx-auto mt-8 bg-white bg-cover rounded"
     style="background-image:url('/yggdrasil-easy-pub-sub-in-elixir/tree.jpg'); height: 75vh; background-position: center;"><a class="p-2 rounded-bl-md bg-elixir-100 text-elixir-900 hover:underline"
      href="https://unsplash.com/photos/XBxQZLNBM0Q">
    
      Cover by Todd Quackenbush
  </a></div>
<div class="container max-w-5xl mx-auto -mt-16 md:-mt-20 lg:-mt-64">
  <div class="mx-0 sm:mx-6">
    <div id="post-content" class="w-full p-8 bg-white text-elixir-900 prose max-w-none md:p-16">
      
      <p>When I started coding in Elixir (around 2016), I was working for a financial company. Our product automatically invested money in the Forex market by copying traders&#39; actions (<em>market orders</em>) in real time. We had the following:</p>

<p>
  <figure class="flex flex-col items-center w-full h-auto mx-auto">
    <img src="/yggdrasil-easy-pub-sub-in-elixir/system.png" alt="Our System" />
    <figcaption class="text-center">
      <p>Our System</p>

    </figcaption>
  </figure>
</p>

<p>In other words, our system:</p>

<ol>
<li><strong>Subscribed</strong> to PostgreSQL for receiving <em>trader actions</em>.</li>
<li><strong>Published</strong> to RabbitMQ for:

<ul>
<li>Categorizing <em>trader actions</em>.</li>
<li>And enqueuing <em>trader actions</em> in the proper queue.</li>
</ul></li>
<li><strong>Subscribed</strong> to Redis for receiving updates on prices.</li>
<li><strong>Subscribed</strong> to several RabbitMQ queues for:

<ul>
<li>Receiving the categorized <em>trader actions</em>.</li>
<li>And deciding whether it should open/close some <em>market orders</em> or not.</li>
</ul></li>
<li>Opened and closed <em>market orders</em>.</li>
</ol>

<p>We needed to be able to communicate with three systems (PostgreSQL, RabbitMQ and Redis). However, in general, we only needed three actions:</p>

<ul>
<li><code>subscribe/1</code> to a channel.</li>
<li><code>publish/2</code> a message in a channel.</li>
<li><code>unsubscribe/1</code> from a channel.</li>
</ul>

<p>If we could generalize those three actions into an API, we could then implement three individual adapters for every system to handle the annoying stuff like disconnections, failures, resource management, protocols, etc.</p>

<p><img src="https://media.giphy.com/media/aih5IZkussTiE/giphy.gif" alt="hard"></p>

<h2 id="table-of-contents">Table of Contents</h2>

<ul>
<li><p><a href="#0">Chapter I: Meet Yggdrasil</a></p></li>
<li><p><a href="#1">Chapter II: Yggdrasil and PostgreSQL Notifications</a></p></li>
<li><p><a href="#2">Chapter III: Yggdrasil and RabbitMQ Subscriptions</a></p></li>
<li><p><a href="#3">Chapter IV: Yggdrasil as Distributed PubSub</a></p></li>
<li><p><a href="#4">In the end: One API to Rule Them All</a></p></li>
</ul>

<div class="chapter">
    <h2 id="0">
      Chapter I: Meet Yggdrasil
    </h2>
    <img class="w-48 md:w-64 h-auto"
         style="filter: invert(100%);"
         src="chapter.png"
         alt="Chapter I: Meet Yggdrasil"/>
  </div>

<p>Handling subscriptions should be easy and, in an ideal world, we would only need to know <em>where</em> to connect and <em>start receiving</em> messages right away.</p>

<p>We shouldn&#39;t need to worry about secondary (yet relevant) things like disconnections, failures and managing resources.</p>

<p><img src="https://raw.githubusercontent.com/gmtprime/yggdrasil/master/priv/static/yggdrasil.png" alt="Yggdrasil"></p>

<blockquote>
<p><em>Yggdrasil</em> is an immense mythical tree that connects the nine worlds in Norse cosmology.</p>
</blockquote>

<p><a href="https://github.com/gmtprime/yggdrasil">Yggdrasil</a> was our pub-sub generalization. Using the strong foundations of Phoenix pub-sub library, we built an agnostic publisher/subscriber application that has:</p>

<ul>
<li>Multi node support.</li>
<li>Simple API: <code>subscribe/1</code>, <code>unsubscribe/1</code> and <code>publish/2</code>.</li>
<li>A <code>GenServer</code> wrapper for handling subscriber events easily.</li>
<li>A basic adapter for using Elixir message distribution.</li>
<li>Fault-tolerant adapters for:

<ul>
<li><a href="https://github.com/gmtprime/yggdrasil_redis">Redis</a>.</li>
<li><a href="https://github.com/gmtprime/yggdrasil_postgres">PostgreSQL</a>.</li>
<li><a href="https://github.com/gmtprime/yggdrasil_rabbitmq">RabbitMQ</a>.</li>
</ul></li>
</ul>

<h3 id="one-api-to-rule-them-all">One API to rule them all</h3>

<p>Yggdrasil&#39;s API is very simple:</p>

<ul>
<li>A process subscribes to <code>&quot;my_channel&quot;</code>:</li>
</ul>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir">   <span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:ok</span> <span class="o">=</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">my_channel"</span><span class="p">)</span>
   <span class="n">iex</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
   <span class="p">{</span><span class="ss">:Y_CONNECTED</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">}}</span>
</code></pre></div>
<ul>
<li>A process (in this case the same process) publishes the message <code>&quot;my message&quot;</code> in <code>&quot;my_channel&quot;</code>.</li>
</ul>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir">   <span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:ok</span> <span class="o">=</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">publish</span><span class="p">([</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">my_channel"</span><span class="p">],</span> <span class="sd">"</span><span class="s2">my message"</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>The message should be in the mailbox of the subscriber process:</li>
</ul>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir">   <span class="n">iex</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
   <span class="p">{</span><span class="ss">:Y_EVENT</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="sd">"</span><span class="s2">my message"</span><span class="p">}</span>
</code></pre></div>
<ul>
<li>The subscriber can unsubscribe from the channel to stop receiving messages:</li>
</ul>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir">   <span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:ok</span> <span class="o">=</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">my_channel"</span><span class="p">)</span>
   <span class="n">iex</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
   <span class="p">{</span><span class="ss">:Y_DISCONNECTED</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">}}</span>
</code></pre></div>
<blockquote>
<p><code>flush()</code> cleans the IEx process mailbox. In general, receiving Yggdrasil messages should be the same as receiving messages when the sender uses <code>send/2</code>.</p>
</blockquote>

<p><img src="https://media.giphy.com/media/cdGQHR4Qzefx6/giphy.gif" alt="So easy!"></p>

<h3 id="yggdrasil-behaviour">Yggdrasil behaviour</h3>

<p>Yggdrasil provides a <code>behaviour</code> for writing subscribers easily. Following the previous example, the subscriber could be written as follows:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Subscriber</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Yggdrasil</span>

  <span class="k">def</span> <span class="n">start_link</span> <span class="k">do</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">my_channel"</span><span class="p">]</span>
    <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">[</span><span class="n">channel</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="nv">@impl</span> <span class="no">true</span>
  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="n">_channel</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span> <span class="p">{</span><span class="ss">:mailbox</span><span class="p">,</span> <span class="n">message</span><span class="p">}</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">nil</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This subscriber will print the message as it receives it:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">Subscriber</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:ok</span> <span class="o">=</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">publish</span><span class="p">([</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">my_channel"</span><span class="p">],</span> <span class="sd">"</span><span class="s2">my message"</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:mailbox</span><span class="p">,</span> <span class="sd">"</span><span class="s2">my_message"</span><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>An interesting side-effect is that now we can send messages to any process as long as they are subscribed to the right channel without needing to know the process PID or name.</p>
</blockquote>

<div class="chapter">
    <h2 id="1">
      Chapter II: Yggdrasil and PostgreSQL Notifications
    </h2>
    <img class="w-48 md:w-64 h-auto"
         style="filter: invert(100%);"
         src="chapter.png"
         alt="Chapter II: Yggdrasil and PostgreSQL Notifications"/>
  </div>

<p>One thing I really like about PostgreSQL is its notifications via <code>pg_notify</code>. This feature is very useful when trying to get real-time notifications for certain changes in a databases.</p>

<h3 id="postgresql-notifications">PostgreSQL notifications</h3>

<p>Creating notifications in PostgreSQL is very easy e.g. let&#39;s say we have a table for books:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- User table creation</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">books</span> <span class="p">(</span>
  <span class="n">id</span> <span class="n">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">title</span> <span class="n">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span>
<span class="p">);</span>
</code></pre></div>
<p>and we want JSON notifications in the channel <code>new_books</code> every time a new book is created in our database e.g:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Animal Farm"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>The trigger could be implemented as follows:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- Trigger function creation</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">trigger_new_book</span><span class="p">()</span>
  <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="err">$$</span>
  <span class="k">DECLARE</span>
    <span class="n">payload</span> <span class="n">JSON</span><span class="p">;</span>
  <span class="k">BEGIN</span>
    <span class="n">payload</span> <span class="p">:</span><span class="o">=</span> <span class="n">json_build_object</span><span class="p">(</span>
      <span class="s1">'id'</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
      <span class="s1">'title'</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">title</span>
    <span class="p">);</span>

    <span class="n">PERFORM</span> <span class="n">pg_notify</span><span class="p">(</span><span class="s1">'new_books'</span><span class="p">,</span> <span class="n">payload</span><span class="p">::</span><span class="n">TEXT</span><span class="p">);</span>
    <span class="k">RETURN</span> <span class="k">NEW</span><span class="p">;</span>
  <span class="k">END</span><span class="p">;</span>
  <span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>

<span class="c1">-- Sets the trigger function in 'books' table</span>
<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">books_notify_new_book</span>
  <span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">books</span>
  <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
  <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">trigger_new_book</span><span class="p">();</span>
</code></pre></div>
<p>Then, the following query would trigger our JSON message in the channel <code>new_books</code>:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">books</span> <span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Animal Farm'</span><span class="p">);</span>
</code></pre></div>
<h3 id="the-problem">The Problem</h3>

<p>Though subscribing to our database notifications can be done easily with <a href="https://github.com/elixir-ecto/postgrex">Postgrex</a> library, handling the connections to the database is a bit of a hassle. We need to ensure:</p>

<ul>
<li><strong>Connection multiplexing</strong>: avoiding over consuming database resources.</li>
<li><strong>Fault-tolerant connections</strong>: supporting re-connections in case of failure or disconnection.</li>
<li><strong>Re-connection back-off time</strong>: avoiding overloading the database on multiple re-connections.</li>
</ul>

<p><img src="https://media.giphy.com/media/FrLKYbLI0djKU/giphy.gif" alt="problem"></p>

<h3 id="the-solution">The Solution</h3>

<p><a href="https://github.com/gmtprime/yggdrasil_postgres">Yggdrasil for PostgreSQL</a> is an adapter that supports all the features mentioned above while maintaining Yggdrasil&#39;s simple API e.g:</p>

<p>For our example, we could subscribe to the database messages by doing the following:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">new_books"</span><span class="p">,</span> <span class="ss">adapter:</span> <span class="ss">:postgres</span><span class="p">,</span> <span class="ss">transformer:</span> <span class="ss">:json</span><span class="p">)</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_CONNECTED</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">}}</span>
</code></pre></div>
<p>Running the following query:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">books</span> <span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'1984'</span><span class="p">);</span>
</code></pre></div>
<p>We will get the following message in IEx:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_EVENT</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">id"</span> <span class="o">=&gt;</span> <span class="m">2</span><span class="p">,</span> <span class="sd">"</span><span class="s2">title"</span> <span class="o">=&gt;</span> <span class="sd">"</span><span class="s2">1984"</span><span class="p">}}</span>
</code></pre></div>
<blockquote>
<p><strong>Note</strong>: <code>Yggdrasil</code> comes with built-in message transformers. We&#39;ve used
<code>:json</code> transformer for this example in order to get a map from the JSON
data.</p>
</blockquote>

<p>Additionally, our subscriber could also be an <code>Yggdrasil</code> process e.g:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Books</span><span class="o">.</span><span class="no">Subscriber</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Yggdrasil</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">options</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span>
      <span class="ss">name:</span> <span class="sd">"</span><span class="s2">new_books"</span><span class="p">,</span>
      <span class="ss">adapter:</span> <span class="ss">:postgres</span><span class="p">,</span>
      <span class="ss">transformer:</span> <span class="ss">:json</span>
    <span class="p">]</span>

    <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nv">@impl</span> <span class="no">true</span>
  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="n">_channel</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">id"</span> <span class="o">=&gt;</span> <span class="n">id</span><span class="p">,</span> <span class="sd">"</span><span class="s2">title"</span> <span class="o">=&gt;</span> <span class="n">title</span><span class="p">},</span> <span class="n">_state</span><span class="p">)</span> <span class="k">do</span>
    <span class="o">...</span> <span class="n">handle</span> <span class="n">event</span> <span class="o">...</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">nil</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>It&#39;s also possbible to use <code>Yggdrasil.publish/2</code> with PostgreSQL:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="n">message</span> <span class="o">=</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">id"</span> <span class="o">=&gt;</span> <span class="m">3</span><span class="p">,</span> <span class="sd">"</span><span class="s2">title"</span> <span class="o">=&gt;</span> <span class="sd">"</span><span class="s2">A Brave New World"</span><span class="p">}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">publish</span><span class="p">([</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">new_books"</span><span class="p">,</span> <span class="ss">adapter:</span> <span class="ss">:postgres</span><span class="p">,</span> <span class="ss">transformer:</span> <span class="ss">:json</span><span class="p">],</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div>
<p><img src="https://media.giphy.com/media/zcCGBRQshGdt6/giphy.gif" alt="Too easy!"></p>

<div class="chapter">
    <h2 id="2">
      Chapter III: Yggdrasil and RabbitMQ Subscriptions
    </h2>
    <img class="w-48 md:w-64 h-auto"
         style="filter: invert(100%);"
         src="chapter.png"
         alt="Chapter III: Yggdrasil and RabbitMQ Subscriptions"/>
  </div>

<p>One of the features I really like about RabbitMQ is its queue routing. Its flexibility allows you to do interesting things without much of a hassle. But before I dig deep into RabbitMQ&#39;s routing capabilities, I would like to mention some concepts.</p>

<h3 id="connections-and-channels">Connections and Channels</h3>

<p>RabbitMQ uses not only <strong>connections</strong>, but virtual connections called <strong>channels</strong>. The idea of channels is to introduce multiplexing in a single connection. A small system could establish only one connection with RabbitMQ while opening a channel for every single execution thread e.g:<p>
  <figure class="flex flex-col items-center w-full h-auto mx-auto">
    <img src="/yggdrasil-easy-pub-sub-in-elixir/rabbitmq-connection.png" alt="RabbitMQ channel multiplexing" />
    <figcaption class="text-center">
      <p>A regular RabbitMQ connection</p></p>
<div class="highlight"><pre><code class="language-" data-lang="">&lt;/figcaption&gt;
</code></pre></div>
<p></figure>
</p>
The rule of thumb would be to use:</p>

<ul>
<li>One connection per application.</li>
<li>One channel per process in the application.</li>
</ul>

<blockquote>
<p><strong>Note</strong>: Once our connection starts to be overloaded, we can start adding more connections to our connection pool.</p>
</blockquote>

<p>With a normal RabbitMQ setup, we need to deal with:</p>

<ul>
<li><strong>Connection pools</strong>: avoiding over consuming resources.</li>
<li><strong>Channel cleaning</strong>: avoiding channel memory leaks when they are not closed properly.</li>
<li><strong>Fault-tolerant connections</strong>: supporting re-connections in case of failure or disconnection.</li>
<li><strong>Re-connection back-off time</strong>: avoiding overloading the database on multiple re-connections.</li>
</ul>

<h3 id="exchanges-and-queues">Exchanges and Queues</h3>

<p>An <strong>exchange</strong> is a message router. Every <strong>queue</strong> attached to it will be identified by a <strong>routing key</strong>. Typically, routing keys are words separated by dots e.g. <code>spain.barcelona.gracia</code>.</p>

<p>Additionally, routing keys support wildcards, for example: <code>spain.barcelona.*</code> will match messages with routing keys like <code>spain.barcelona.gracia</code> and <code>spain.barcelona.raval</code>.</p>

<p>It&#39;s easier to see these concepts with an image example:<p>
  <figure class="flex flex-col items-center w-full h-auto mx-auto">
    <img src="/yggdrasil-easy-pub-sub-in-elixir/rabbitmq-exchange.png" alt="RabbitMQ exchange routing" />
    <figcaption class="text-center">
      <p>A RabbitMQ exchange</p></p>
<div class="highlight"><pre><code class="language-" data-lang="">&lt;/figcaption&gt;
</code></pre></div>
<p></figure>
</p>
In the previous image:</p>

<ul>
<li><strong><strong>Publisher X</strong></strong> and <strong><strong>Publisher Y</strong></strong> are sending messages to <strong><em>Exchange logs</em></strong>.</li>
<li><strong><strong>Subscriber A</strong></strong> is subscribed to <code>logs.*</code>.</li>
<li><strong><strong>Subscriber B</strong></strong> is subscribed to <code>logs.error</code>.</li>
</ul>

<p>Then:</p>

<ul>
<li><strong><strong>Publisher X</strong></strong> message will end up in <strong><em>Queue</em></strong> <code>logs.info</code>.</li>
<li><strong><strong>Publisher Y</strong></strong> message will end up in <strong><em>Queue</em></strong> <code>logs.error</code>.</li>
<li><strong><strong>Subscriber A</strong></strong> will receive <strong><strong>Publisher X</strong></strong> and <strong><strong>Publisher Y</strong></strong>&#39;s messages.</li>
<li><strong><strong>Subscriber B</strong></strong> will receive <strong><strong>Publisher Y</strong></strong>&#39;s message.</li>
</ul>

<p><img src="https://media.giphy.com/media/3o6gDSdED1B5wjC2Gc/giphy.gif" alt="Information Overload"></p>

<h3 id="handling-subscriptions-in-yggdrasil">Handling Subscriptions in Yggdrasil</h3>

<p>Handling RabbitMQ&#39;s complexity might be intimidating. Fortunately, <a href="https://github.com/gmtprime/yggdrasil_rabbitmq">Yggdrasil for RabbitMQ</a> generalizes the complexity in order to have a simpler API.</p>

<p>The biggest difference with previous adapters is the channel name. Instead of being a string, it&#39;s a tuple with the exchange name and the routing key e.g:</p>

<p>A subscriber would connect to the exchange <code>amq.topic</code> using the routing key <code>logs.*</code> as follows:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="ss">name:</span> <span class="p">{</span><span class="sd">"</span><span class="s2">amq.topic"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">logs.*"</span><span class="p">},</span> <span class="ss">adapter:</span> <span class="ss">:rabbitmq</span><span class="p">)</span>
<span class="n">iex</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_CONNECTED</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">}}</span>
</code></pre></div>
<blockquote>
<p><strong>Note</strong>: The exchange must exist and its type should be <code>topic</code>. The exchange <code>amq.topic</code> is created by default in RabbitMQ.</p>
</blockquote>

<p>Then a publisher could send a message to the exchange <code>amq.topic</code> using <code>logs.info</code> as routing key:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">publish</span><span class="p">([</span><span class="ss">name:</span> <span class="p">{</span><span class="sd">"</span><span class="s2">amq.topic"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">logs.info"</span><span class="p">},</span> <span class="ss">adapter:</span> <span class="ss">:rabbitmq</span><span class="p">],</span> <span class="sd">"</span><span class="s2">Some message"</span><span class="p">)</span>
<span class="ss">:ok</span>
</code></pre></div>
<p>Finally, the subscriber would receive the message:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_EVENT</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="sd">"</span><span class="s2">Some message"</span><span class="p">}</span>
</code></pre></div>
<p>Additionally, the subscriber can be written using the <code>Yggdrasil</code> behaviour:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Logs</span><span class="o">.</span><span class="no">Subscriber</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Yggdrasil</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">options</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span>
      <span class="ss">name:</span> <span class="p">{</span><span class="sd">"</span><span class="s2">amq.topic"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">logs.*"</span><span class="p">},</span>
      <span class="ss">adapter:</span> <span class="ss">:rabbitmq</span>
    <span class="p">]</span>

    <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nv">@impl</span> <span class="no">true</span>
  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="n">_channel</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="k">do</span>
    <span class="o">...</span> <span class="n">handle</span> <span class="n">event</span> <span class="o">...</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">nil</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="lost-messages">Lost Messages</h3>

<p>Yggdrasil will acknowledge the messages as soon as they arrive to the adapter, then it will broadcast them to all the subscribers. If the adapter is alive while the subscribers are restarting/failing, some messages might be lost.</p>

<p>Though it&#39;s possible to overcome this problem with exclusive queues, this feature is not implemented yet.</p>

<p><img src="https://media.giphy.com/media/5YuhLwDgrgtRVwI7OY/giphy.gif" alt="Penguin&#39;s queueing"></p>

<div class="chapter">
    <h2 id="3">
      Chapter IV: Yggdrasil as Distributed PubSub
    </h2>
    <img class="w-48 md:w-64 h-auto"
         style="filter: invert(100%);"
         src="chapter.png"
         alt="Chapter IV: Yggdrasil as Distributed PubSub"/>
  </div>

<p>Yggdrasil&#39;s default adapter supports multi-node subscriptions out-of-the-box thanks to <a href="https://github.com/phoenixframework/phoenix_pubsub">Phoenix PubSub</a>. This distributed capabilities can be extended to any adapter compatible with Yggdrasil v5.0 without writing a single line of extra code.</p>

<p><img src="https://media.giphy.com/media/Qtpdtlk9rpb8PKK0ih/giphy.gif" alt="Spock is interested!"></p>

<h2 id="before-we-start">Before We Start</h2>

<p>I&#39;ve used <a href="https://https://github.com/alexdesousa/alexdesousa.github.io/tree/blog/examples/matrix">this example project</a>
 for the code in this article. You can skip this section safely as long as you remember the following:</p>

<ul>
<li><code>Basic</code> project has only Yggdrasil.</li>
<li><code>Rabbit</code> project has Yggdrasil for RabbitMQ.</li>
<li>A RabbitMQ server is available.</li>
<li>The host name is called <code>matrix</code>. Your machine&#39;s will be different.</li>
</ul>

<p>If you want to follow along with the examples in this article, you can download the example project using the following command:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git clone <span class="nt">--depth</span> 2 <span class="nt">-b</span> blog https://https://github.com/alexdesousa/alexdesousa.github.io examples <span class="o">&amp;&amp;</span> <span class="nb">cd </span>examples <span class="o">&amp;&amp;</span> git filter-branch <span class="nt">--prune-empty</span> <span class="nt">--subdirectory-filter</span> examples/matrix HEAD
</code></pre></div>
<p>In the folder you&#39;ll find:</p>

<ul>
<li><a href="https://https://github.com/alexdesousa/alexdesousa.github.io/tree/blog/examples/matrix/basic">Basic project</a></li>
</ul>

<p>that has a basic version of <a href="https://github.com/gmtprime/yggdrasil">Yggdrasil</a>.
- <a href="https://https://github.com/alexdesousa/alexdesousa.github.io/tree/blog/examples/matrix/rabbit">Rabbit project</a></p>

<p>that has <a href="https://github.com/gmtprime/yggdrasil_rabbitmq">Yggdrasil for RabbitMQ</a>.
- A docker compose with a RabbitMQ server:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">   <span class="nv">$ </span><span class="nb">cd </span>rabbit <span class="o">&amp;&amp;</span> docker-compose up
</code></pre></div>
<p><img src="https://media.giphy.com/media/bKnEnd65zqxfq/giphy.gif" alt="Make it so"></p>

<h2 id="basic-message-distribution">Basic Message Distribution</h2>

<p>Yggdrasil&#39;s default adapter piggybacks on Phoenix PubSub for the message delivery, inheriting its distributed capabilities e.g. let&#39;s say we have the following:</p>

<ul>
<li>The node <code>:neo@matrix</code> using <code>Basic</code> project:</li>
</ul>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">   <span class="nv">$ </span>iex <span class="nt">--sname</span> neo <span class="nt">-S</span> mix
</code></pre></div>
<ul>
<li>The node <code>:smith@matrix</code> also using <code>Basic</code> project:</li>
</ul>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">   <span class="nv">$ </span>iex <span class="nt">--sname</span> smith <span class="nt">-S</span> mix
</code></pre></div>
<ul>
<li>Both nodes are interconnected:</li>
</ul>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir">   <span class="n">iex</span><span class="p">(</span><span class="n">smith</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">1</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="ss">:neo</span><span class="nv">@matrix</span><span class="p">)</span>
   <span class="no">true</span>
</code></pre></div>
<p>Then <code>:smith@matrix</code> can subscribe to any channel where <code>:neo@matrix</code> is publishing messages e.g:</p>

<p>In <code>:smith@matrix</code>, we subscribe to the channel <code>&quot;private&quot;</code>:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">smith</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">2</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">private"</span><span class="p">)</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="p">(</span><span class="n">smith</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">3</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_CONNECTED</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">}}</span>
<span class="ss">:ok</span>
</code></pre></div>
<p>In <code>:neo@matrix</code>, we publish a message in the channel <code>&quot;private&quot;</code>:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">neo</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">1</span><span class="o">&gt;</span> <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">private"</span><span class="p">]</span>
<span class="n">iex</span><span class="p">(</span><span class="n">neo</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">2</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="sd">"</span><span class="s2">What's the Matrix?"</span><span class="p">)</span>
<span class="ss">:ok</span>
</code></pre></div>
<p>Finally, we can flush <code>:smith@matrix</code> mailbox and find our message:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">smith</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">4</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_EVENT</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="sd">"</span><span class="s2">What's the Matrix?"</span><span class="p">}</span>
<span class="ss">:ok</span>
</code></pre></div>
<p>Distributed pubsub as simple as that.</p>

<p><img src="https://media.giphy.com/media/dWy2WwcB3wvX8QA1Iu/giphy.gif" alt="Easy"></p>

<h2 id="bridged-message-distribution">Bridged Message Distribution</h2>

<p>The bridge adapter makes a <em>bridge</em> between any Yggdrasil adapter and the default adapter. This allows adapters to inherit the distributed capabilities of the default adapter e.g. let&#39;s say we have the following:</p>

<ul>
<li>The node <code>:neo@matrix</code> using <code>Basic</code> project:</li>
</ul>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">   <span class="nv">$ </span>iex <span class="nt">--sname</span> neo <span class="nt">-S</span> mix
</code></pre></div>
<ul>
<li>The node <code>:trinity@matrix</code> using <code>Rabbit</code> project:</li>
</ul>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">   <span class="nv">$ </span>iex <span class="nt">--sname</span> trinity <span class="nt">-S</span> mix
</code></pre></div>
<ul>
<li>The node <code>:trinity@matrix</code> has access to a RabbitMQ server.</li>
<li>Both nodes are interconnected:</li>
</ul>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir">   <span class="n">iex</span><span class="p">(</span><span class="n">trinity</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">1</span><span class="o">&gt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="ss">:neo</span><span class="nv">@matrix</span><span class="p">)</span>
   <span class="no">true</span>
</code></pre></div>
<p>So our final infrastructure would look like the following:<p>
  <figure class="flex flex-col items-center w-full h-auto mx-auto">
    <img src="/yggdrasil-easy-pub-sub-in-elixir/bridge-adapter-example.png" alt="A node using a bridge adapter to connect to RabbitMQ" />
    <figcaption class="text-center">
      <p>A node using a bridge adapter to connect to RabbitMQ</p></p>
<div class="highlight"><pre><code class="language-" data-lang="">&lt;/figcaption&gt;
</code></pre></div>
<p></figure>
</p>
Now that our nodes are connected, every adapter is available to them.</p>

<p>Through <code>:trinity@matrix</code>, the node <code>:neo@matrix</code> can now subscribe to
a RabbitMQ exchange:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">neo</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">1</span><span class="o">&gt;</span> <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span><span class="ss">name:</span> <span class="p">{</span><span class="sd">"</span><span class="s2">amq.topic"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">private"</span><span class="p">},</span> <span class="ss">adapter:</span> <span class="ss">:rabbitmq</span><span class="p">]</span>
<span class="n">iex</span><span class="p">(</span><span class="n">neo</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">2</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="p">(</span><span class="n">neo</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">3</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_CONNECTED</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">}}</span>
<span class="ss">:ok</span>
</code></pre></div>
<p>Or even publish messages:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="p">(</span><span class="n">neo</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">4</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="sd">"</span><span class="s2">What's the Matrix?"</span><span class="p">)</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="p">(</span><span class="n">neo</span><span class="nv">@matrix</span><span class="p">)</span><span class="m">3</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_EVENT</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="sd">"</span><span class="s2">What's the Matrix?"</span><span class="p">}</span>
<span class="ss">:ok</span>
</code></pre></div>
<p>The good thing about this feature is that it works with any adapter that supports Yggdrasil v5.0.</p>

<p><img src="https://media.giphy.com/media/1zRd5ZNo0s6kLPifL1/giphy.gif" alt="The future is now!"></p>

<div class="chapter">
    <h2 id="4">
      In the end: One API to Rule Them All
    </h2>
    <img class="w-48 md:w-64 h-auto"
         style="filter: invert(100%);"
         src="chapter.png"
         alt="In the end: One API to Rule Them All"/>
  </div>

<p><a href="https://github.com/gmtprime/yggdrasil">Yggdrasil</a> hides the complexity of a pub/sub and let&#39;s you focus in what really matters: <strong>messages</strong>.</p>

<p>Hope you found this article useful. Happy coding!</p>

<p><img src="https://media.giphy.com/media/26xBENWdka2DSvvag/giphy.gif" alt="Heck yeah!"></p>

    </div><div class="flex items-center w-full p-8 font-sans md:p-16">
  <img class="w-24 h-24 mr-4 rounded-full"
       src="/assets/images/profile/alex.jpg"
       alt="Avatar of Alex de Sousa"/>
  <div class="flex-1">
    <p class="text-base font-bold leading-none text-elixir-900 md:text-xl">Alex de Sousa</p>
    <p class="mt-2 text-xs text-gray-700 md:text-base">Refill Aqua co-founder. Elixir alchemist. Tech enthusiast.</p>
  </div>
</div>
<div class="flex flex-wrap justify-center py-6"><div class="flex flex-col w-full p-6 md:w-1/2 lg:w-5/12">
  <div class="flex-1 overflow-hidden bg-white rounded-t rounded-b-none shadow-lg">
    <a href="/skogsra-simplifying-your-elixir-configuration" class="flex flex-wrap no-underline hover:no-underline">
      <div class="w-full h-64 bg-center bg-cover"
           style="background-image:url('/skogsra-simplifying-your-elixir-configuration/small/skogsra.jpg'">
      </div>
      <p class="w-full px-6 pt-6 pb-3 text-xs text-gray-600 md:text-sm">Alex de Sousa</p>
      <h2 class="w-full px-6 mb-4 text-xl font-bold text-gray-900">SkogsrÃ¥: Simplifying Your Elixir Configuration</h2>
      <p class="px-6 mb-5 font-serif text-base text-gray-800">Improving Elixir configurations for small and large projects.</p>
    </a>
  </div>
  <div class="flex-none p-6 mt-auto overflow-hidden bg-white rounded-t-none rounded-b shadow-lg">
    <div class="flex items-center justify-between">
      <img class="w-8 h-8 mr-4 rounded-full avatar"
           data-tippy-content="Alex de Sousa"
           src="/assets/images/profile/alex.jpg"
           alt="Avatar of Alex de Sousa"/>
      <p class="text-xs text-gray-600 md:text-sm">3 min read</p>
    </div>
  </div>
</div>
<div class="flex flex-col w-full p-6 md:w-1/2 lg:w-5/12">
  <div class="flex-1 overflow-hidden bg-white rounded-t rounded-b-none shadow-lg">
    <a href="/syntax-highlighting-in-jekyll" class="flex flex-wrap no-underline hover:no-underline">
      <div class="w-full h-64 bg-center bg-cover"
           style="background-image:url('/syntax-highlighting-in-jekyll/small/jekyll.jpg'">
      </div>
      <p class="w-full px-6 pt-6 pb-3 text-xs text-gray-600 md:text-sm">Alex de Sousa</p>
      <h2 class="w-full px-6 mb-4 text-xl font-bold text-gray-900">Syntax highlighting in Jekyll</h2>
      <p class="px-6 mb-5 font-serif text-base text-gray-800">Using Redcarpet markdown renderer to add pygments to Jekyll</p>
    </a>
  </div>
  <div class="flex-none p-6 mt-auto overflow-hidden bg-white rounded-t-none rounded-b shadow-lg">
    <div class="flex items-center justify-between">
      <img class="w-8 h-8 mr-4 rounded-full avatar"
           data-tippy-content="Alex de Sousa"
           src="/assets/images/profile/alex.jpg"
           alt="Avatar of Alex de Sousa"/>
      <p class="text-xs text-gray-600 md:text-sm">1 min read</p>
    </div>
  </div>
</div>
</div></div>
</div>
<footer class="bg-elixir-900">
  <div class="container flex items-center max-w-6xl px-2 py-8 mx-auto">
    <div class="flex flex-wrap items-center w-full mx-auto">
      <div class="flex justify-center w-full font-extrabold text-white md:w-1/2 md:justify-start">
        <a class="no-underline hover:text-gray-900 hover:no-underline"
           href="/en">
          <span class="text-base text-elixir-100"><svg
  class="inline stroke-current text-elixir-100 w-6 h-6"
   viewBox="0 0 69.572713 69.572715">
  <g>
    <path
       style="fill:none;stroke-width:2.91042;stroke-linecap:butt;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 23.864295,1.579337 14.99178,24.721084 -12.37421,0.60924 15.62853,23.161723 L 2.4193453,17.515564 18.357715,17.818914 5.3962653,1.455208 Z"/>
    <path
       style="fill:none;stroke-width:4.7625;stroke-linecap:square;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 41.021355,10.837556 c 0,0 17.70631,-8.639798 23.91889,7.395197 6.504443,16.788311 -13.56254,23.213201 -13.56254,23.213201"/>
    <path
       style="fill:none;stroke-width:4.7625;stroke-linecap:square;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
       d="m 36.521655,54.560714 c 0,0 -8.42371,19.61708 -23.89037,9.96633 -15.4666597,-9.65075 -3.0563697,-26.62966 -3.0563697,-26.62966"/>
  </g>
</svg>
The Broken Link</span>
        </a>
      </div>
      <div class="flex content-center justify-between w-full pt-2 md:w-1/2 md:justify-end">
        <ul class="flex items-center justify-center flex-1 list-reset md:flex-none"><li>
            <a class="flex items-center h-10 p-2 text-center no-underline text-elixir-500 hover:text-elixir-100 hover:text-underline md:h-auto md:p-4 avatar"
               data-tippy-content="Alex de Sousa's CV"
               href="https://thebroken.link/cv/">Alex de Sousa's CV</a>
          </li>
          <li>
            <a class="flex items-center h-10 p-2 text-center no-underline text-elixir-500 hover:text-elixir-100 hover:text-underline md:h-auto md:p-4 avatar"
               data-tippy-content="@thebroken_link"
               href="https://twitter.com/thebroken_link">
              <svg class="h-6 fill-current" viewBox="0 0 32 32">
                <path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z">
                </path>
              </svg>
            </a>
          </li>
          <li>
            <a class="flex items-center h-10 p-2 text-center no-underline text-elixir-500 hover:text-elixir-100 hover:text-underline md:h-auto md:p-4 avatar"
               data-tippy-content="@alexdesousa"
               href="https://github.com/alexdesousa/">
              <svg class="h-6 fill-current" viewBox="0 0 512 512">
                <g>
                  <path d="M409.132,114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736,15.166,259.057,5.365,219.271,5.365
          c-39.781,0-76.472,9.804-110.063,29.408c-33.596,19.605-60.192,46.204-79.8,79.8C9.803,148.168,0,184.854,0,224.63
          c0,47.78,13.94,90.745,41.827,128.906c27.884,38.164,63.906,64.572,108.063,79.227c5.14,0.954,8.945,0.283,11.419-1.996
          c2.475-2.282,3.711-5.14,3.711-8.562c0-0.571-0.049-5.708-0.144-15.417c-0.098-9.709-0.144-18.179-0.144-25.406l-6.567,1.136
          c-4.187,0.767-9.469,1.092-15.846,1c-6.374-0.089-12.991-0.757-19.842-1.999c-6.854-1.231-13.229-4.086-19.13-8.559
          c-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559
          c-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-0.951-2.568-2.098-3.711-3.429c-1.142-1.331-1.997-2.663-2.568-3.997
          c-0.572-1.335-0.098-2.43,1.427-3.289c1.525-0.859,4.281-1.276,8.28-1.276l5.708,0.853c3.807,0.763,8.516,3.042,14.133,6.851
          c5.614,3.806,10.229,8.754,13.846,14.842c4.38,7.806,9.657,13.754,15.846,17.847c6.184,4.093,12.419,6.136,18.699,6.136
          c6.28,0,11.704-0.476,16.274-1.423c4.565-0.952,8.848-2.383,12.847-4.285c1.713-12.758,6.377-22.559,13.988-29.41
          c-10.848-1.14-20.601-2.857-29.264-5.14c-8.658-2.286-17.605-5.996-26.835-11.14c-9.235-5.137-16.896-11.516-22.985-19.126
          c-6.09-7.614-11.088-17.61-14.987-29.979c-3.901-12.374-5.852-26.648-5.852-42.826c0-23.035,7.52-42.637,22.557-58.817
          c-7.044-17.318-6.379-36.732,1.997-58.24c5.52-1.715,13.706-0.428,24.554,3.853c10.85,4.283,18.794,7.952,23.84,10.994
          c5.046,3.041,9.089,5.618,12.135,7.708c17.705-4.947,35.976-7.421,54.818-7.421s37.117,2.474,54.823,7.421l10.849-6.849
          c7.419-4.57,16.18-8.758,26.262-12.565c10.088-3.805,17.802-4.853,23.134-3.138c8.562,21.509,9.325,40.922,2.279,58.24
          c15.036,16.18,22.559,35.787,22.559,58.817c0,16.178-1.958,30.497-5.853,42.966c-3.9,12.471-8.941,22.457-15.125,29.979
          c-6.191,7.521-13.901,13.85-23.131,18.986c-9.232,5.14-18.182,8.85-26.84,11.136c-8.662,2.286-18.415,4.004-29.263,5.146
          c9.894,8.562,14.842,22.077,14.842,40.539v60.237c0,3.422,1.19,6.279,3.572,8.562c2.379,2.279,6.136,2.95,11.276,1.995
          c44.163-14.653,80.185-41.062,108.068-79.226c27.88-38.161,41.825-81.126,41.825-128.906
          C438.536,184.851,428.728,148.168,409.132,114.573z"/>
                </g>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script>
      document.addEventListener('scroll', function() {
        const scrollTop = document.documentElement['scrollTop'] || document.body['scrollTop'];
        const scrollHeight = document.documentElement['scrollHeight'] || document.body['scrollHeight'];
        const scrollBottom = scrollHeight - document.documentElement.clientHeight;
        const scroll = scrollTop / scrollBottom * 100;

        document
          .getElementById('progress-bar')
          .style.setProperty('--scroll', `${scroll}%`);
      }, {passive: true});
    </script>
  </body>
</html>
