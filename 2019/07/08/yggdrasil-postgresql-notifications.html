<!DOCTYPE html>
<html lang="en-US">
  <head>
    

<!-- general -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Yggdrasil adapter for handling pg_notify notifications from PostgreSQL" />
<meta name="robots" content="index, follow">
<meta name="author" content="Alex de Sousa" />

<!-- title -->
<title>Yggdrasil: PostgreSQL Notifications | The Broken Link</title>

<!-- favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- Google card -->
<meta itemprop="description" content="Yggdrasil adapter for handling pg_notify notifications from PostgreSQL" />
<meta itemprop="image" content="https://thebroken.link/assets/img/yggdrasil-postgresql-notifications/image.png" />

<!-- Facebook card -->
<meta property="og:type" content="website" />
<meta property="og:site_name" content="The Broken Link">
<meta property="og:title" content="Yggdrasil: PostgreSQL Notifications" />
<meta property="og:image" content="https://thebroken.link/assets/img/yggdrasil-postgresql-notifications/image.png" />
<meta property="og:url" content="https://thebroken.link" />
<meta property="og:description" content="Yggdrasil adapter for handling pg_notify notifications from PostgreSQL" />

<!-- Twitter card -->
<meta name="twitter:title" content="Yggdrasil: PostgreSQL Notifications" />
<meta name="twitter:description" content="Yggdrasil adapter for handling pg_notify notifications from PostgreSQL" />
<meta name="twitter:image" content="https://thebroken.link/assets/img/yggdrasil-postgresql-notifications/image.png" />
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image:alt" content="The Broken Link Blog">
<meta name="twitter:site" content="@thebroken_link">

<!-- styles -->
<link rel="stylesheet" href="/assets/css/pygments/monokai.css?version=20190624">
<link rel="stylesheet" href="/assets/css/main.css?version=20190624">

<!-- metadata -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://thebroken.link/2019/07/08/yggdrasil-postgresql-notifications.html"
  },
  "headline": "Yggdrasil: PostgreSQL Notifications",
  "image": [
    "https://example.com/photos/1x1/photo.jpg",
    "https://example.com/photos/4x3/photo.jpg",
    "https://example.com/photos/16x9/photo.jpg"
   ],
  "datePublished": "2019-07-08T00:00:00+00:00",
  "dateModified": "2019-07-08T00:00:00+00:00",
  "author": {
    "@type": "Person",
    "name": "Alex de Sousa"
  },
  "publisher": {
    "@type": "Organization",
    "name": "The Broken Link"
    "logo": {
      "@type": "ImageObject",
      "url": "https://thebroken.link/assets/img/logo.png"
    }
  },
  "description": "Yggdrasil adapter for handling pg_notify notifications from PostgreSQL
}
</script>


  </head>
  <body>
    <div class="page">
      <div class="navigation">
        <a class="navigation-logo" href="/">
  <img class="logo-image"
       alt="The Broken Link"
       src="/assets/img/logo.png"/>
</a>
<nav class="navigation-bar">
  
    <a href="/"
       class="nav-link-inactive">
      Home
    </a>
  
    <a href="/blog.html"
       class="nav-link-inactive">
      Blog
    </a>
  
    <a href="/about.html"
       class="nav-link-inactive">
      About
    </a>
  
</nav>

      </div>
      <div class="content">
        <article>
          <div class="header">
  <h1 class="title">Yggdrasil: PostgreSQL Notifications</h1>
  


  <div class="header-info">
    <img class="header-info-child avatar" src="/assets/img/alex.png" alt="alex"/>
    <div class="header-info-child author"> Alex de Sousa </div>
    <div class="header-info-child read-time">
      08 Jul 2019 &nbsp;&middot;&nbsp; 

3 min read


    </div>
  </div>


</div>

          <p>One thing I really like about PostgreSQL is its notifications via <code>pg_notify</code>.
This feature is very useful when trying to get real-time notifications for
certain changes in our databases.</p>

<h2>PostgreSQL Notifications</h2>

<p>Creating notifications in PostgreSQL is very easy e.g:</p>

<p>Let&#39;s say we have a table for books:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- User table creation</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">books</span> <span class="p">(</span>
    <span class="n">id</span> <span class="n">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">title</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span>
  <span class="p">);</span>
</code></pre></div>
<p>and we want JSON notifications in the channel <code>new_books</code> every time a
new book is created in our database e.g:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Animal Farm"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>The trigger could be implemented as follows:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- Trigger function creation</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">trigger_new_book</span><span class="p">()</span>
  <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="err">$$</span>
  <span class="k">DECLARE</span>
    <span class="n">payload</span> <span class="n">TEXT</span><span class="p">;</span>
  <span class="k">BEGIN</span>
    <span class="n">payload</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'{'</span>
            <span class="o">||</span> <span class="s1">'"id":'</span>     <span class="o">||</span> <span class="k">NEW</span><span class="p">.</span><span class="n">id</span>    <span class="o">||</span> <span class="s1">','</span>
            <span class="o">||</span> <span class="s1">'"title":"'</span> <span class="o">||</span> <span class="k">NEW</span><span class="p">.</span><span class="n">title</span> <span class="o">||</span> <span class="s1">'"'</span>
            <span class="o">||</span> <span class="s1">'}'</span><span class="p">;</span>

    <span class="n">PERFORM</span> <span class="n">pg_notify</span><span class="p">(</span><span class="s1">'new_books'</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
    <span class="k">RETURN</span> <span class="k">NEW</span><span class="p">;</span>
  <span class="k">END</span><span class="p">;</span>
  <span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>

<span class="c1">-- Sets the trigger function in 'books' table</span>
<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">books_notify_new_book</span>
  <span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">books</span>
  <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
  <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">trigger_new_book</span><span class="p">();</span>
</code></pre></div>
<p>Then, the following query would trigger our JSON message in the channel
<code>new_books</code>:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">books</span> <span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Animal Farm'</span><span class="p">);</span>
</code></pre></div>
<h2>The Problem</h2>

<p>Though subscribing to our database notifications can be done easily with
<a href="https://github.com/elixir-ecto/postgrex">Postgrex</a> library, handling the
connections to the database is a bit of a hassle. We need to ensure:</p>

<ul>
<li>Connection multiplexing between subscribers in order to avoid over consuming
database resources.</li>
<li>Fault-toletant connections by supporting reconnections in case of failure or
disconnection.</li>
<li>Reconnection backoff time (preferrably an exponential) for reconnectiong to
avoid overloading the database.</li>
</ul>

<h2>The Solution</h2>

<p><a href="https://github.com/gmtprime/yggdrasil_postgres">Yggdrasil for PostgreSQL</a> is
an adapter that supports all the features mentioned above while maintaining
Yggdrasil&#39;s simple API e.g:</p>

<p>For our example, we could subcribe to the database messages by doing the
following:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="ss">name:</span> <span class="sd">"</span><span class="s2">new_books"</span><span class="p">,</span> <span class="ss">adapter:</span> <span class="ss">:postgres</span><span class="p">,</span> <span class="ss">transformer:</span> <span class="ss">:json</span><span class="p">)</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_CONNECTED</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">}}</span>
</code></pre></div>
<p>Running the following query:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">books</span> <span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'1984'</span><span class="p">);</span>
</code></pre></div>
<p>We will get the following message in IEx:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="n">flush</span><span class="p">()</span>
<span class="p">{</span><span class="ss">:Y_EVENT</span><span class="p">,</span> <span class="p">%</span><span class="no">Yggdrasil</span><span class="o">.</span><span class="no">Channel</span><span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">id"</span> <span class="o">=&gt;</span> <span class="m">2</span><span class="p">,</span> <span class="sd">"</span><span class="s2">title"</span> <span class="o">=&gt;</span> <span class="sd">"</span><span class="s2">1984"</span><span class="p">}}</span>
</code></pre></div>
<p>Additionally, our subscriber could also be an <code>Yggdrasil</code> process e.g:</p>
<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Books</span><span class="o">.</span><span class="no">Subscriber</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Yggdrasil</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">options</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span>
      <span class="ss">name:</span> <span class="sd">"</span><span class="s2">new_books"</span><span class="p">,</span>
      <span class="ss">adapter:</span> <span class="ss">:postgres</span><span class="p">,</span>
      <span class="ss">transformer:</span> <span class="ss">:json</span>
    <span class="p">]</span>

    <span class="no">Yggdrasil</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nv">@impl</span> <span class="no">true</span>
  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="n">_channel</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">id"</span> <span class="o">=&gt;</span> <span class="n">id</span><span class="p">,</span> <span class="sd">"</span><span class="s2">title"</span> <span class="o">=&gt;</span> <span class="n">title</span><span class="p">},</span> <span class="n">_state</span><span class="p">)</span> <span class="k">do</span>
    <span class="o">...</span> <span class="n">handle</span> <span class="n">event</span> <span class="o">...</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="no">nil</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2>Conclusion</h2>

<p><a href="https://github.com/gmtprime/yggdrasil_postgres">Yggdrasil for PostgreSQL</a>
simplifies subscriptions to PostgreSQL notifications and let&#39;s you focus in
what really matters: <strong>messages</strong>.</p>

        </article>
        
<div style="margin: 40px 75px 10px 75px; border: 1px solid #CCCCCC;"></div>
<div class="boxes">
  

  
    <!-- Previous article -->
    
    <div class="box">
  <img class="box-child box-image"
       alt="Yggdrasil: Easy Pub-Sub in Elixir"
       src="/assets/img/yggdrasil-easy-pub-sub-in-elixir/image.png"/>
  <a class="box-child box-title nav-link-inactive" href="/2019/07/06/yggdrasil-easy-pub-sub-in-elixir.html">Yggdrasil: Easy Pub-Sub in Elixir</a>
  <span class="box-child box-description">An overview of Yggdrasil capabilities</span>
  <span class="box-child box-read-time read-time">
    06 Jul 2019
    &nbsp;&middot;&nbsp;
    

3 min read


  </span>
</div>

  
</div>


      </div>
      <div class="footer">
        <div class="footer-copyright">
  <span class="by-alex"> Copyright 2019 Alexander de Sousa</span>
</div>
<div class="footer-social-media">
  <a href="https://github.com/alexdesousa">
    <img class="social-media github"
        src="/assets/img/github.png"
        alt="Github"/>
  </a>
  <a href="https://twitter.com/thebroken_link">
    <img class="social-media twitter"
        src="/assets/img/twitter.png"
        alt="Twitter"/>
  </a>
  <a href="https://stackoverflow.com/users/4776680/alexander-de-sousa?tab=topactivity">
    <img class="social-media stackoverflow"
        src="/assets/img/stackoverflow.png"
        alt="Stack Overflow"/>
  </a>
  <a href="https://www.linkedin.com/in/ajdesousa/">
    <img class="social-media linkedin"
        src="/assets/img/linkedin.png"
        alt="Linked In"/>
  </a>
</div>

      </div>
    </div>
  </body>
</html>
